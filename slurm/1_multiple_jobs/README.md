# Get counts MPI program

In the [Getting Started](../getting_started/README.md) section, all processing was performed within a single Slurm job that executed the Python code.
The bitstring of a Qiskit Sampler result represents the classical measurement outcome (0s and 1s) of the qubits after a quantum circuit is executed. It is a string representation of the binary state, where each character corresponds to a bit value, often ordered with the most significant bit on the left (n−1n-1n−1) and the least significant on the right (0).
In this section, we split the workflow into two separate jobs by implementing the post‑processing step as an independent MPI program. The post‑processing stage derives the occurrence frequencies of the bitstrings contained in the Qiskit Sampler results.

## Modify sampler_qrmi.py to generate input.bin for MPI program

Add the following lines at the tail.

```python
bitstrings = results[0].data.meas.get_bitstrings()
print("bitstrings >>>> ", len(bitstrings))
u32int_array = np.array(
    [int(b, base=2) for b in bitstrings],
        dtype=np.uint32,
    )
print(u32int_array)
u32int_array.tofile("input.bin")
```

## Create MPI program and build

[get_counts.cpp](./get_counts.cpp)

It reads the ```input.bin``` file generated by the modified sampler_qrmi.py, distributes the list of integer values converted from the bitstrings using ```MPI_Scatter()```, and then collects their occurrence counts using ```MPI_Reduce()``` before writing the final results to ```output.json```.

Build ```get_counts.cpp```.
```bash
mpicxx -o get_counts get_counts.cpp
```

## Create Slurm script for get_counts.cpp

[get_counts_job.sh](./get_counts_job.sh)

```bash
#!/bin/bash
#SBATCH --job-name=get_counts      # Job name
#SBATCH --nodes=2                # Request 2 nodes
#SBATCH --ntasks-per-node=2      # 4 MPI tasks per node
#SBATCH --time=00:05:00          # Time limit (hh:mm:ss)
#SBATCH -p normal

echo "Starting at `date`"
echo "Running on hosts: $SLURM_NODELIST"
echo "Running on $SLURM_NNODES nodes."
echo "Running $SLURM_NTASKS tasks."
echo "Current working directory is `pwd`"

# Run the MPI program using srun or mpirun
# srun is often the preferred method with Slurm
srun ./get_counts
# Alternatively, you could use mpirun:
# mpirun ./get_counts
```

## Create run.sh to run 

[run.sh](./run.sh)

You submit the two jobs using the ```sbatch``` command. The second script, ```get_counts_job.sh```, runs only if the first script, ```run_sampler.sh```, completes successfully.

```bash
#!/bin/bash
jobidA=$(sbatch run_sampler.sh | awk '{print $4}')
sbatch --dependency=afterok:$jobidA /shared/job_scripts/mpi/get_counts/get_counts_job.sh
```

## Run the jobs

```bash
./run.sh
```

## Review the result

You must find [output.json](./output.json) once jobs are completed.

